--- xnu-4570.41.2/libsyscall/Libsyscall.xcconfig
+++ xnu-4570.41.2/libsyscall/Libsyscall.xcconfig
@@ -26,11 +26,11 @@
 WARNING_CFLAGS = -Wmost
 GCC_TREAT_WARNINGS_AS_ERRORS = YES
 GCC_WARN_ABOUT_MISSING_NEWLINE = YES
 CODE_SIGN_IDENTITY = -
 DYLIB_CURRENT_VERSION = $(RC_ProjectSourceVersion)
-DYLIB_LDFLAGS = -umbrella System -all_load -lCrashReporterClient
+DYLIB_LDFLAGS = -umbrella System -all_load // -lCrashReporterClient
 DYLIB_LDFLAGS[sdk=iphoneos*] = $(inherited) -Wl,-sectalign,__DATA,__data,1000
 DYLIB_LDFLAGS[sdk=watchos*] = $(inherited) -Wl,-sectalign,__DATA,__data,1000
 DYLIB_LDFLAGS[sdk=tvos*] = $(inherited) -Wl,-sectalign,__DATA,__data,1000
 DYLIB_LDFLAGS[sdk=appletvos*] = $(inherited) -Wl,-sectalign,__DATA,__data,1000
 DYLIB_LDFLAGS[sdk=bridgeos*] = $(inherited) -Wl,-sectalign,__DATA,__data,1000
--- xnu-4570.41.2/libsyscall/Libsyscall.xcodeproj/project.pbxproj
+++ xnu-4570.41.2/libsyscall/Libsyscall.xcodeproj/project.pbxproj
@@ -108,17 +108,10 @@
 		29A59AE6183B110C00E8B896 /* unlinkat.c in Sources */ = {isa = PBXBuildFile; fileRef = 29A59AE5183B110C00E8B896 /* unlinkat.c */; };
 		2BA88DCC1810A3CE00EB63F6 /* coalition.c in Sources */ = {isa = PBXBuildFile; fileRef = 2BA88DCB1810A3CE00EB63F6 /* coalition.c */; };
 		3695DCC91F3D2C5F0072C0B3 /* reboot.c in Sources */ = {isa = PBXBuildFile; fileRef = 3695DCC81F3D2C5A0072C0B3 /* reboot.c */; };
 		374A36E314748F1300AAF39D /* varargs_wrappers.s in Sources */ = {isa = PBXBuildFile; fileRef = 374A36E214748EE400AAF39D /* varargs_wrappers.s */; };
 		3F538F891A659C5600B37EFD /* persona.c in Sources */ = {isa = PBXBuildFile; fileRef = 3F538F881A659C5600B37EFD /* persona.c */; };
-		401BB71A1BCAE57B005080D3 /* os_channel.c in Sources */ = {isa = PBXBuildFile; fileRef = 401BB7161BCAE539005080D3 /* os_channel.c */; settings = {COMPILER_FLAGS = "-fno-builtin"; }; };
-		401BB71C1BCAE57B005080D3 /* os_nexus.c in Sources */ = {isa = PBXBuildFile; fileRef = 401BB7181BCAE539005080D3 /* os_nexus.c */; settings = {COMPILER_FLAGS = "-fno-builtin"; }; };
-		402AF43F1E5CD88600F1A4B9 /* cpu_in_cksum_gen.c in Sources */ = {isa = PBXBuildFile; fileRef = 402AF43E1E5CD88100F1A4B9 /* cpu_in_cksum_gen.c */; settings = {COMPILER_FLAGS = "-fno-builtin"; }; };
-		403C7CEE1E1F4E4400D6FEEF /* os_packet.c in Sources */ = {isa = PBXBuildFile; fileRef = 405FA3381E0C669D007D66EA /* os_packet.c */; settings = {COMPILER_FLAGS = "-fno-builtin"; }; };
-		406E0B721E4ACD2000295EA3 /* cpu_copy_in_cksum.s in Sources */ = {isa = PBXBuildFile; fileRef = 40DD162F1E4ACCAA003297CC /* cpu_copy_in_cksum.s */; };
-		409A78321E4EB3E300E0699B /* cpu_in_cksum.s in Sources */ = {isa = PBXBuildFile; fileRef = 409A78301E4EB3D900E0699B /* cpu_in_cksum.s */; };
-		40DF0F741E5CD7BB0035A864 /* cpu_copy_in_cksum_gen.c in Sources */ = {isa = PBXBuildFile; fileRef = 40DF0F731E5CD7B30035A864 /* cpu_copy_in_cksum_gen.c */; settings = {COMPILER_FLAGS = "-fno-builtin"; }; };
 		435F3CAA1B06B7BA005ED9EF /* work_interval.c in Sources */ = {isa = PBXBuildFile; fileRef = 435F3CA91B06B7BA005ED9EF /* work_interval.c */; };
 		467DAFD4157E8AF200CE68F0 /* guarded_open_np.c in Sources */ = {isa = PBXBuildFile; fileRef = 467DAFD3157E8AF200CE68F0 /* guarded_open_np.c */; };
 		4BDD5F1D1891AB2F004BF300 /* mach_approximate_time.c in Sources */ = {isa = PBXBuildFile; fileRef = 4BDD5F1B1891AB2F004BF300 /* mach_approximate_time.c */; };
 		4BDD5F1E1891AB2F004BF300 /* mach_approximate_time.s in Sources */ = {isa = PBXBuildFile; fileRef = 4BDD5F1C1891AB2F004BF300 /* mach_approximate_time.s */; };
 		729B7D0A15C8938C000E2501 /* carbon_delete.c in Sources */ = {isa = PBXBuildFile; fileRef = FB50F1B315AB7DE700F814BA /* carbon_delete.c */; };
@@ -136,14 +129,10 @@
 		9299E14B1B841F59005B7350 /* thread_state.h in Headers */ = {isa = PBXBuildFile; fileRef = 928336A21B8412C100873B90 /* thread_state.h */; };
 		929FD46F1C5711DB0087B9C8 /* mach_timebase_info.c in Sources */ = {isa = PBXBuildFile; fileRef = 929FD46E1C5711CF0087B9C8 /* mach_timebase_info.c */; };
 		978228281B8678DC008385AC /* pselect-darwinext.c in Sources */ = {isa = PBXBuildFile; fileRef = 978228271B8678CB008385AC /* pselect-darwinext.c */; };
 		978228291B8678DF008385AC /* pselect-darwinext-cancel.c in Sources */ = {isa = PBXBuildFile; fileRef = 978228261B8678C2008385AC /* pselect-darwinext-cancel.c */; };
 		9CCF28271E68E993002EE6CD /* pid_shutdown_networking.c in Sources */ = {isa = PBXBuildFile; fileRef = 9CCF28261E68E993002EE6CD /* pid_shutdown_networking.c */; };
-		A50845861DDA69AC0041C0E0 /* thread_self_restrict.h in CopyFiles */ = {isa = PBXBuildFile; fileRef = A50BD52E1DDA548F006622C8 /* thread_self_restrict.h */; };
-		A50845871DDA69C90041C0E0 /* thread_self_restrict.h in CopyFiles */ = {isa = PBXBuildFile; fileRef = A50BD52E1DDA548F006622C8 /* thread_self_restrict.h */; };
-		A50BD52F1DDA548F006622C8 /* thread_self_restrict.h in Headers */ = {isa = PBXBuildFile; fileRef = A50BD52E1DDA548F006622C8 /* thread_self_restrict.h */; };
-		A50BD5301DDA5500006622C8 /* thread_self_restrict.h in Headers */ = {isa = PBXBuildFile; fileRef = A50BD52E1DDA548F006622C8 /* thread_self_restrict.h */; };
 		A59CB95616669EFB00B064B3 /* stack_logging_internal.h in Headers */ = {isa = PBXBuildFile; fileRef = A59CB95516669DB700B064B3 /* stack_logging_internal.h */; };
 		A59CB9581666A1A200B064B3 /* munmap.c in Sources */ = {isa = PBXBuildFile; fileRef = A59CB9571666A1A200B064B3 /* munmap.c */; };
 		BA0D9FB1199031AD007E8A73 /* kdebug_trace.c in Sources */ = {isa = PBXBuildFile; fileRef = BA0D9FB0199031AD007E8A73 /* kdebug_trace.c */; };
 		BA4414AA18336A5F00AAE813 /* mach in CopyFiles */ = {isa = PBXBuildFile; fileRef = BA4414A51833697C00AAE813 /* mach */; };
 		BA4414AB18336A6400AAE813 /* servers in CopyFiles */ = {isa = PBXBuildFile; fileRef = BA4414A6183369A100AAE813 /* servers */; };
@@ -386,22 +375,20 @@
 			isa = PBXCopyFilesBuildPhase;
 			buildActionMask = 8;
 			dstPath = "$(OS_PRIVATE_HEADERS_FOLDER_PATH)";
 			dstSubfolderSpec = 0;
 			files = (
-				A50845871DDA69C90041C0E0 /* thread_self_restrict.h in CopyFiles */,
 				C9FD8508166D6BD400963B73 /* tsd.h in CopyFiles */,
 			);
 			runOnlyForDeploymentPostprocessing = 1;
 		};
 		C6D3EFCA16542C510052CF30 /* CopyFiles */ = {
 			isa = PBXCopyFilesBuildPhase;
 			buildActionMask = 8;
 			dstPath = "$(OS_PRIVATE_HEADERS_FOLDER_PATH)";
 			dstSubfolderSpec = 0;
 			files = (
-				A50845861DDA69AC0041C0E0 /* thread_self_restrict.h in CopyFiles */,
 				C9A3D6EB1672AD1000A5CAA3 /* tsd.h in CopyFiles */,
 			);
 			runOnlyForDeploymentPostprocessing = 1;
 		};
 /* End PBXCopyFilesBuildPhase section */
@@ -1078,11 +1065,10 @@
 				9299E14B1B841F59005B7350 /* thread_state.h in Headers */,
 				C6D3EFBB16542C510052CF30 /* mach_init.h in Headers */,
 				C6D3EFBC16542C510052CF30 /* mach_interface.h in Headers */,
 				C6D3EFBD16542C510052CF30 /* port_obj.h in Headers */,
 				C6D3EFBE16542C510052CF30 /* sync.h in Headers */,
-				A50BD52F1DDA548F006622C8 /* thread_self_restrict.h in Headers */,
 				C6D3EFC116542C510052CF30 /* vm_task.h in Headers */,
 				C6D3EFC216542C510052CF30 /* key_defs.h in Headers */,
 				C6D3EFC316542C510052CF30 /* ls_defs.h in Headers */,
 				C6D3EFC416542C510052CF30 /* netname_defs.h in Headers */,
 				C6D3EFC516542C510052CF30 /* nm_defs.h in Headers */,
@@ -1113,11 +1099,10 @@
 				9299E14A1B841E74005B7350 /* thread_state.h in Headers */,
 				C6C40122174155E3000AE69F /* gethostuuid_private.h in Headers */,
 				C9D9BD29114B00600000D8B9 /* mach_interface.h in Headers */,
 				C9D9BD2B114B00600000D8B9 /* port_obj.h in Headers */,
 				C9D9BD2C114B00600000D8B9 /* sync.h in Headers */,
-				A50BD5301DDA5500006622C8 /* thread_self_restrict.h in Headers */,
 				C9D9BD2F114B00600000D8B9 /* vm_task.h in Headers */,
 				C9D9BD50114B00600000D8B9 /* key_defs.h in Headers */,
 				C9D9BD51114B00600000D8B9 /* ls_defs.h in Headers */,
 				C9D9BD54114B00600000D8B9 /* netname_defs.h in Headers */,
 				C9D9BD55114B00600000D8B9 /* nm_defs.h in Headers */,
@@ -1302,18 +1287,16 @@
 		};
 		D2AAC0610554660B00DB518D /* Sources */ = {
 			isa = PBXSourcesBuildPhase;
 			buildActionMask = 2147483647;
 			files = (
-				403C7CEE1E1F4E4400D6FEEF /* os_packet.c in Sources */,
 				E214BDC81C2E358300CEE8A3 /* clonefile.c in Sources */,
 				C9D9BD19114B00600000D8B9 /* clock_priv.defs in Sources */,
 				C9D9BD1A114B00600000D8B9 /* clock_reply.defs in Sources */,
 				C9D9BD1C114B00600000D8B9 /* clock.defs in Sources */,
 				C9D9BD22114B00600000D8B9 /* exc.defs in Sources */,
 				C9D9BD30114B00600000D8B9 /* host_priv.defs in Sources */,
-				409A78321E4EB3E300E0699B /* cpu_in_cksum.s in Sources */,
 				C9D9BD31114B00600000D8B9 /* host_security.defs in Sources */,
 				C9D9BD35114B00600000D8B9 /* lock_set.defs in Sources */,
 				C9D9BD38114B00600000D8B9 /* mach_host.defs in Sources */,
 				C9D9BD3D114B00600000D8B9 /* mach_port.defs in Sources */,
 				C9D9BD3F114B00600000D8B9 /* mach_vm.defs in Sources */,
@@ -1391,11 +1374,10 @@
 				139D584B1C7BDE41003D3B17 /* terminate_with_reason.c in Sources */,
 				248BA05C121C9649008C073F /* fcntl-cancel.c in Sources */,
 				248BA069121D9E27008C073F /* getrlimit.c in Sources */,
 				C6460B7C182025DF00F73CCA /* sfi.c in Sources */,
 				248BA080121DA36B008C073F /* ioctl.c in Sources */,
-				401BB71A1BCAE57B005080D3 /* os_channel.c in Sources */,
 				C6BEE9181806840200D25AAB /* posix_sem_obsolete.c in Sources */,
 				248BA082121DA4F3008C073F /* kill.c in Sources */,
 				248BA085121DA5E4008C073F /* kill.c in Sources */,
 				9CCF28271E68E993002EE6CD /* pid_shutdown_networking.c in Sources */,
 				2BA88DCC1810A3CE00EB63F6 /* coalition.c in Sources */,
@@ -1413,25 +1395,21 @@
 				4BDD5F1E1891AB2F004BF300 /* mach_approximate_time.s in Sources */,
 				248BA0B3121DE760008C073F /* select-cancel.c in Sources */,
 				248BA0BE121DE902008C073F /* select.c in Sources */,
 				248BA0CD121DEBEF008C073F /* setrlimit.c in Sources */,
 				24B223B0121DFD36007DAEDE /* sigsuspend.c in Sources */,
-				401BB71C1BCAE57B005080D3 /* os_nexus.c in Sources */,
 				24B223B2121DFE6D007DAEDE /* sigsuspend-cancel.c in Sources */,
 				E4216C311822D404006F2632 /* mach_voucher.defs in Sources */,
 				24B223B5121DFF29007DAEDE /* sigsuspend.c in Sources */,
 				248AA963122C7B2A0085F5B1 /* unlink.c in Sources */,
 				248AA965122C7C330085F5B1 /* rmdir.c in Sources */,
 				435F3CAA1B06B7BA005ED9EF /* work_interval.c in Sources */,
 				248AA967122C7CDA0085F5B1 /* rename.c in Sources */,
-				406E0B721E4ACD2000295EA3 /* cpu_copy_in_cksum.s in Sources */,
 				24B8C2621237F53900D36CC3 /* remove-counter.c in Sources */,
 				C99A4F501305B2BD0054B7B7 /* __get_cpu_capabilities.s in Sources */,
 				978228291B8678DF008385AC /* pselect-darwinext-cancel.c in Sources */,
-				40DF0F741E5CD7BB0035A864 /* cpu_copy_in_cksum_gen.c in Sources */,
 				C99A4F531305B43F0054B7B7 /* init_cpu_capabilities.c in Sources */,
-				402AF43F1E5CD88600F1A4B9 /* cpu_in_cksum_gen.c in Sources */,
 				030B179B135377B400DAD1F0 /* open_dprotected_np.c in Sources */,
 				E4D45C3116F868ED0002AF25 /* proc_listpidspath.c in Sources */,
 				374A36E314748F1300AAF39D /* varargs_wrappers.s in Sources */,
 				291D3C281354FDD100D46061 /* mach_port.c in Sources */,
 				291D3C291354FDD100D46061 /* mach_vm.c in Sources */,
--- xnu-4570.41.2/osfmk/i386/cpu_topology.c
+++ xnu-4570.41.2/osfmk/i386/cpu_topology.c
@@ -35,10 +35,11 @@
 #include <i386/machine_cpu.h>
 #include <i386/bit_routines.h>
 #include <i386/cpu_data.h>
 #include <i386/lapic.h>
 #include <i386/machine_routines.h>
+#include <stddef.h>
 
 __private_extern__ void qsort(
     void * array,
     size_t nmembers,
     size_t member_size,
--- a/Makefile
+++ b/Makefile
@@ -40,15 +40,17 @@ default: install
 
 # default to OS X
 SDKROOT ?= macosx.internal
+RC_BuildRoot ?= /
 
 installhdrs install:
 	cd libsyscall ; \
 		xcodebuild $@ $(TARGET)	\
-			"SRCROOT=$(SRCROOT)/libsyscall"					\
-			"OBJROOT=$(OBJROOT)"						\
-			"SYMROOT=$(SYMROOT)"						\
-			"DSTROOT=$(DSTROOT)"						\
-			"SDKROOT=$(SDKROOT)"
+			"SRCROOT=$(SRCROOT)/libsyscall"	\
+			"OBJROOT=$(OBJROOT)" \
+			"SYMROOT=$(SYMROOT)" \
+			"DSTROOT=$(DSTROOT)" \
+			"SDKROOT=$(SDKROOT)" \
+			"ADDITIONAL_SDKS=$(RC_BuildRoot)"
 
 clean:

diff --git a/libsyscall/xcodescripts/compile-syscalls.pl b/libsyscall/xcodescripts/compile-syscalls.pl
index f0c2691..e9ff30e 100755
--- a/libsyscall/xcodescripts/compile-syscalls.pl
+++ b/libsyscall/xcodescripts/compile-syscalls.pl
@@ -63,7 +63,10 @@ my @CFLAGS = (
 	"-x assembler-with-cpp",
 	"-c",
 	"-isysroot", $ENV{'SDKROOT'} || "/",
+	"-isysroot", $ENV{'ADDITIONAL_SDKS'} || "/",
 	"-I".$ENV{"SDKROOT"}."/System/Library/Frameworks/System.framework/PrivateHeaders",
+	"-I".$ENV{"ADDITIONAL_SDKS"}."/System/Library/Frameworks/System.framework/PrivateHeaders",
+	"-I".$ENV{"ADDITIONAL_SDKS"}."/System/Library/Frameworks/Kernel.framework/PrivateHeaders",
 );
 
 chomp(my $LIBTOOL = `xcrun -sdk "$ENV{'SDKROOT'}" -find libtool`);
